<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AeroRoute - Airport Route Optimizer</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Vis.js -->
    <script src="https://unpkg.com/vis-network@9.1.2/dist/vis-network.min.js"></script>
    <link href="https://unpkg.com/vis-network@9.1.2/styles/vis-network.min.css" rel="stylesheet">
    <style>
        body { background-color: #0f172a; color: #f8fafc; font-family: 'Segoe UI', system-ui, sans-serif; }
        .card { background-color: #1e293b; border-color: #334155; color: white; margin-bottom: 20px; }
        .form-label { color: #94a3b8; }
        .form-control, .form-select { background-color: #334155; border-color: #475569; color: white; }
        .form-control:focus, .form-select:focus { background-color: #334155; color: white; border-color: #3b82f6; box-shadow: 0 0 0 0.25rem rgba(59, 130, 246, 0.25); }
        .btn-primary { background-color: #3b82f6; border-color: #3b82f6; width: 100%; font-weight: 600; padding: 10px; }
        .btn-primary:hover { background-color: #2563eb; }
        #mynetwork { width: 100%; height: 650px; border: 1px solid #475569; border-radius: 8px; background-color: #1a202c; }
        h1, h2, h3 { font-weight: 700; letter-spacing: -0.025em; }
        .result-box { background: rgba(59, 130, 246, 0.1); border-left: 4px solid #3b82f6; padding: 15px; border-radius: 4px; }
        .navbar { background-color: #1e293b !important; }
    </style>
</head>
<body>
    <nav class="navbar navbar-dark mb-4 border-bottom border-secondary">
        <div class="container-fluid px-4">
            <span class="navbar-brand mb-0 h1 d-flex align-items-center">
                ✈️ AeroRoute &nbsp;<span class="badge bg-primary text-small" style="font-size: 0.6em;">PRO</span>
            </span>
        </div>
    </nav>

    <div class="container-fluid px-4">
        <div class="row">
            <!-- Sidebar / Control Panel -->
            <div class="col-md-3">
                <div class="card shadow-sm">
                    <div class="card-header bg-transparent border-secondary fw-bold text-uppercase small letter-spacing-1">Configuration</div>
                    <div class="card-body">
                         {% if error %}
                        <div class="alert alert-danger">{{ error }}</div>
                        {% endif %}
                        
                        <form method="POST">
                            <div class="mb-3">
                                <label class="form-label">Start Point</label>
                                <select name="start" class="form-select">
                                    {% for node in nodes %}
                                    <option value="{{ node }}" {% if request.form.start == node|string %}selected{% endif %}>{{ labels[node]|default(node) }}</option>
                                    {% endfor %}
                                </select>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Destination</label>
                                <select name="end" class="form-select">
                                    {% for node in nodes %}
                                    <option value="{{ node }}" {% if request.form.end == node|string %}selected{% endif %}>{{ labels[node]|default(node) }}</option>
                                    {% endfor %}
                                </select>
                            </div>

                            <div class="row">
                                <div class="col-6 mb-3">
                                    <label class="form-label">Time (0-24)</label>
                                    <input type="number" name="time_of_day" class="form-control" value="{{ request.form.time_of_day|default(12) }}" required min="0" max="23">
                                </div>
                                <div class="col-6 mb-3">
                                    <label class="form-label">Traffic (1-10)</label>
                                    <input type="number" name="traffic_level" class="form-control" value="{{ request.form.traffic_level|default(5) }}" required min="1" max="10">
                                </div>
                            </div>

                            <div class="mb-4">
                                <label class="form-label">Weather Conditions</label>
                                <select name="weather" class="form-select">
                                    <option {% if request.form.weather == 'Clear' %}selected{% endif %}>Clear</option>
                                    <option {% if request.form.weather == 'Rain' %}selected{% endif %}>Rain</option>
                                    <option {% if request.form.weather == 'Fog' %}selected{% endif %}>Fog</option>
                                </select>
                            </div>

                            <button type="submit" class="btn btn-primary">Find Optimal Route</button>
                        </form>
                    </div>
                </div>

                {% if result %}
                <div class="card shadow-sm mt-3">
                    <div class="card-header bg-transparent border-secondary fw-bold text-success text-uppercase small">Optimization Results</div>
                    <div class="card-body">
                        {% if result.error %}
                             <div class="alert alert-warning">{{ result.error }}</div>
                        {% else %}
                             <div class="mb-4 text-center">
                                <small class="text-muted d-block text-uppercase small">Total Estimated Time</small>
                                <h2 class="display-4 fw-bold text-white">{{ result.total_estimate }}<span class="fs-4 text-muted">min</span></h2>
                             </div>
                             
                             <div class="result-box mb-4">
                                <small class="text-uppercase text-primary fw-bold">Optimal Path</small><br>
                                <div style="max-height: 100px; overflow-y: auto; font-size: 0.9em;">
                                    {{ result.readable_path | join(" → ") }}
                                </div>
                             </div>

                             <ul class="list-group list-group-flush bg-transparent">
                                <li class="list-group-item bg-transparent text-light d-flex justify-content-between px-0">
                                    <span>Distance</span>
                                    <span>{{ result.raw_distance }} m</span>
                                </li>
                                <li class="list-group-item bg-transparent text-light d-flex justify-content-between px-0">
                                    <span>Base Travel Time</span>
                                    <span>{{ result.time }} min</span>
                                </li>
                                <li class="list-group-item bg-transparent text-warning d-flex justify-content-between px-0">
                                    <span>Predicted Delay</span>
                                    <span>+{{ result.predicted_delay }} min</span>
                                </li>
                             </ul>
                        {% endif %}
                    </div>
                </div>
                {% endif %}
            </div>

            <!-- Main Map View -->
            <div class="col-md-9">
                <div class="card shadow-sm h-100">
                    <div class="card-body p-0">
                        <div id="mynetwork"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const path = {{ result.path | tojson if result else '[]' }};
        const labelMap = {{ labels | tojson }};

        // Identify path edges
        const pathEdges = new Set();
        if (path && path.length) {
            for (let i = 0; i < path.length - 1; i++) {
                pathEdges.add(`${path[i]}->${path[i + 1]}`);
            }
        }

        const nodes = new vis.DataSet([
            {% for node in nodes %}
            {
                id: {{ node }},
                label: labelMap["{{ node }}"] || "{{ node }}",
                color: {
                    background: path.includes({{ node }}) ? '#ef4444' : '#3b82f6',
                    border: '#fff',
                },
                font: { color: '#e2e8f0', size: 14, face: 'arial' },
                borderWidth: 2,
                shadow: true
            },
            {% endfor %}
        ]);

        const edges = new vis.DataSet([
            {% for edge in edges %}
            {
                from: {{ edge.from }},
                to: {{ edge.to }},
                label: "{{ edge.label }} m",
                arrows: "to",
                color: {
                    color: pathEdges.has("{{ edge.from }}->{{ edge.to }}") ? "#ef4444" : "#475569",
                    opacity: pathEdges.has("{{ edge.from }}->{{ edge.to }}") ? 1 : 0.4
                },
                width: pathEdges.has("{{ edge.from }}->{{ edge.to }}") ? 4 : 1,
                font: { align: 'middle', color: '#94a3b8', size: 10, strokeWidth: 0 }
            },
            {% endfor %}
        ]);

        const container = document.getElementById("mynetwork");
        const data = { nodes, edges };

        const options = {
            layout: { randomSeed: 2 },
            physics: {
                enabled: true,
                barnesHut: {
                    gravitationalConstant: -3000,
                    centralGravity: 0.3,
                    springLength: 150,
                    springConstant: 0.04,
                    damping: 0.09,
                    avoidOverlap: 0.1
                },
                stabilization: { iterations: 150 }
            },
            interaction: {
                hover: true,
                navigationButtons: true,
                keyboard: true,
                zoomView: true
            },
            nodes: {
                shape: 'dot',
                size: 10
            }
        };

        const network = new vis.Network(container, data, options);
    </script>
</body>
</html>
